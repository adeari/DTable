/*! dtable - v0.1.0 - 2014-02-06
* https://github.com/kubanka-peter/dtable
* Copyright (c) 2014 Kubi; Licensed MIT */

var DTableModule=function(a){var b=function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/,c=function(){};return c.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d},c}(),c=0,d=1,e=2,f=3,g=4,h=5,i=6,j=7,k=b.extend({isLoaded:!1,init:function(){},loading:function(){}}),l={};l[d]=k.extend({getTitle:function(){},getColumns:function(){},getPagination:function(){},getSearch:function(){},hasColumnFilter:function(){},hasColumnTitle:function(){}}),l[c]=k.extend({getTableHtml:function(){},getRowsHtml:function(){},getPaginationHtml:function(){}}),l[e]=b.extend({error:function(){},info:function(){}}),l[f]=k.extend({getRows:function(){},getCount:function(){}}),l[g]=b.extend({update:function(){},getParams:function(){}}),l[h]=b.extend({getPage:function(){},setPage:function(){},getShowFirstLast:function(){},getPageNum:function(){},getRowsPerPage:function(){},setRowsPerPage:function(){},getMaxPage:function(){},getPagesArr:function(){},getOffset:function(){}}),l[i]=b.extend({startLoading:function(){},stopLoading:function(){}}),l[j]=b.extend({getOrderBy:function(){}});var m=[],n=b.extend({init:function(){this.MODULE_TEMPLATE=c,this.MODULE_DEFINITION=d,this.MODULE_LOGGER=e,this.MODULE_SOURCE=f,this.MODULE_SEARCH=g,this.MODULE_PAGINATION=h,this.MODULE_LOADING=i,this.MODULE_ORDER=j,a.each(l,function(a){m[a]={}})},getModule:function(a,b,c,d){if(void 0==m[a])throw"Invalid DTableModule type";if(void 0==m[a][b])throw"DTableModule '"+b+"' doesn't exist.";return new m[a][b](c,d)},newModule:function(a,b,c){if(void 0==m[a])throw"Invalid DTableModule type";if(void 0!=m[a][b])throw"DTableModule "+b+" already exist.";m[a][b]=l[a].extend(c)},extendModule:function(a,b,c,d){if(void 0==m[a])throw"Invalid DTableModule type";if(void 0==m[a][b])throw"DTableModule '"+name+"' doesn't exist.";if(void 0!=m[a][c])throw"DTableModule "+c+" already exist.";m[a][c]=m[a][b].extend(d)}});return new n}(jQuery);!function(a,b){function c(c,d){var e={definition:{name:"json_url",options:{}},template:{name:"nunjucks",options:{}},logger:{name:"default",options:{}},source:{name:"json_url",options:{}},search:{name:"default",options:{}},pagination:{name:"default",options:{}},loading:{name:"default",options:{}},order:{name:"default",options:{}}};this.table=c,this.options=a.extend(!0,{},e,d),this.definition=b.getModule(b.MODULE_DEFINITION,this.options.definition.name,this.options.definition.options,this),this.pagination=b.getModule(b.MODULE_PAGINATION,this.options.pagination.name,this.options.pagination.options,this),this.template=b.getModule(b.MODULE_TEMPLATE,this.options.template.name,this.options.template.options,this),this.logger=b.getModule(b.MODULE_LOGGER,this.options.logger.name,this.options.logger.options,this),this.source=b.getModule(b.MODULE_SOURCE,this.options.source.name,this.options.source.options,this),this.search=b.getModule(b.MODULE_SEARCH,this.options.search.name,this.options.search.name,this),this.loading=b.getModule(b.MODULE_LOADING,this.options.loading.name,this.options.loading.options,this),this.order=b.getModule(b.MODULE_ORDER,this.options.order.name,this.options.order.options,this),this.init()}c.prototype.renderTable=function(){var a=this.template.getTableHtml({title:this.definition.getTitle(),pagination:this.definition.getPagination(),search:this.definition.getSearch(),columns:this.definition.getColumns(),has_column_filter:this.definition.hasColumnFilter(),has_column_title:this.definition.hasColumnTitle()});this.table.html(a)},c.prototype.renderRows=function(){var a=this.template.getRowsHtml({rows:this.source.getRows(),columns:this.definition.getColumns()}),b=this.table.find('[data-dtable="table"]');b.length?b.html(a):this.logger.error('Can\'t find rows root element [data-dtable="table"]')},c.prototype.renderPagination=function(){var a="",b=this.pagination.getPagesArr();b&&(a=this.template.getPaginationHtml({first:1,last:this.pagination.getMaxPage(),pages:b,active:this.pagination.getPage(),first_last:this.definition.getPagination().show_first_last}));var c=this.table.find('[data-dtable="pagination"]');c.html(a)},c.prototype.update=function(a){this.loading.startLoading();var b=this;b.source.loading(function(){b.loading.stopLoading(),b.renderRows(),b.renderPagination(),a&&a()})},c.prototype.init=function(){function a(){b.definition.isLoaded&&b.template.isLoaded&&(b.renderTable(),b.update())}var b=this;this.definition.loading(a),this.template.loading(a)},a.fn.dtable=function(a){var b;return this.data("DTable")?b=this.data("DTable"):(b=new c(this,a),this.data("DTable",b)),b}}(jQuery,DTableModule),function(a){a.newModule(a.MODULE_LOADING,"default",{init:function(a,b){this.dtable=b,this.div=!1,this.enabled=!1,this.is_loading=!1;var c=b.table.find('[data-dtable="loading"]');c.length&&(this.enabled=!0,this.div=c)},startLoading:function(){var a=this;!this.is_loading&&this.enabled&&(this.is_loading=!0,setTimeout(function(){a.is_loading&&a.dtable.table.find('[data-dtable="loading-container"]').html(a.div)},300))},stopLoading:function(){if(this.enabled){this.is_loading=!1;var a=this.dtable.table.find('[data-dtable="loading"]');a.length&&a.remove()}}})}(DTableModule,jQuery),function(a){a.newModule(a.MODULE_LOGGER,"default",{init:function(a,b){var c={debug:!1};this.dtable=b,this.options=$.extend({},c,a)},error:function(a){throw this.dtable.loading.stopLoading(),this.dtable.table.html("Error."),a},info:function(a){this.options.debug&&console.log(a)}})}(DTableModule),function(a,b){a.newModule(a.MODULE_ORDER,"default",{init:function(a,c){var d={};this.options=b.extend({},d,a),this.dtable=c,this.columns="";var e=this;this.dtable.table.on("click",'[data-dtable="order.asc"]',function(){return e.setOrder(b(this),"asc"),!1}),this.dtable.table.on("click",'[data-dtable="order.desc"]',function(){return e.setOrder(b(this),"desc"),!1})},setOrder:function(a,b){this.dtable.table.find('[data-dtable="order.asc"]').removeClass("active"),this.dtable.table.find('[data-dtable="order.desc"]').removeClass("active"),a.addClass("active"),this.columns={},this.columns[a.attr("data-dtable-column")]=b,this.dtable.search.update()},getOrderBy:function(){return this.columns}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_PAGINATION,"default",{init:function(a,c){var d={show_first_and_last:!0,pages:5,rows_per_page:20};this.page=1,this.dtable=c,this.options=b.extend({},d,a);var e=this;c.table.on("click",'[data-dtable="page"]',function(){var a=b(this),c=a.attr("data-page");return e.setPage(c),!1})},getPage:function(){return this.page},setPage:function(a){this.page=parseInt(a),this.dtable.search.update()},getShowFirstLast:function(){return this.options.show_first_and_last},getPageNum:function(){return this.options.pages},getRowsPerPage:function(){return this.options.rows_per_page},setRowsPerPage:function(a){this.options.rows_per_page=a},getMaxPage:function(){return Math.ceil(this.dtable.source.getCount()/this.dtable.definition.getPagination().rows_per_page)},getOffset:function(){return this.page*this.options.rows_per_page-this.options.rows_per_page},getPagesArr:function(){var a=this.getMaxPage(),b=1,c=Math.round((this.dtable.definition.getPagination().pages-1)/2),d=this.getPage()-c,e=this.getPage()+c;d=Math.max(b,d),e=Math.min(a,e),e<this.dtable.definition.getPagination().pages&&(e=Math.min(this.dtable.definition.getPagination().pages,a)),e-d<this.dtable.definition.getPagination().pages&&(d=e-this.dtable.definition.getPagination().pages+1,b>d&&(d=b));var f=!1;if(d!=e){f=[];for(var g=d;e>=g;g++)f.push(g)}return f}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_SEARCH,"default",{init:function(a,c){var d={placeholder:"search ...",waiting:600};this.search="",this.filter="",this.in_progress=!1,this.update_after=!1,this.options=b.extend({},d,a),this.dtable=c;var e=this;this.dtable.table.on("keyup",'[data-dtable="search"]',function(){e.search=b(this).val(),e.dtable.pagination.setPage(1),e.update()}),this.dtable.table.on("keyup",'[data-dtable="filter"]',function(){var a=b(this);""===e.filter&&(e.filter={}),e.filter[a.attr("data-column")]=a.val(),e.dtable.pagination.setPage(1),e.update()})},update:function(){var a=parseInt(this.options.waiting);if(this.update_after=(new Date).getTime()+a,!this.in_progress){this.in_progress=!0;var b=this,c=function(){(new Date).getTime()>=b.update_after?(b.in_progress=!1,b.dtable.update()):setTimeout(c,a/2)};setTimeout(c,a/2)}},getParams:function(){var a={search:this.search,filter:this.filter,per_page:this.dtable.definition.getPagination().rows_per_page,offset:this.dtable.pagination.getOffset(),order:this.dtable.order.getOrderBy()};return a}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_DEFINITION,"json_url",{init:function(a,c){this.definition={},this.isLoaded=!1;var d={method:"get",url:"",data:{},timestamp:!1};this.dtable=c,this.options=b.extend({},d,a)},getTitle:function(){return this.definition.title},getColumns:function(){return this.definition.columns},getPagination:function(){return{show_first_last:this.dtable.pagination.getShowFirstLast(),pages:this.dtable.pagination.getPageNum(),rows_per_page:this.dtable.pagination.getRowsPerPage()}},getSearch:function(){return{placeholder:this.dtable.search.options.placeholder}},hasColumnFilter:function(){return this.definition.has_column_filter},hasColumnTitle:function(){return this.definition.has_column_title},loading:function(a){function c(c){e.definition=c,e.isLoaded=!0,e.dtable.logger.info("json_url.definition: resource is loaded"),e.definition.has_column_filter=!1,e.definition.has_column_title=!1,b.each(e.getColumns(),function(a,b){b.filter&&(e.definition.has_column_filter=!0),b.title&&(e.definition.has_column_title=!0)}),a()}var d=this.options.url,e=this,f="POST";"get"==this.options.method&&(f="GET"),b.ajax(d,{url:d,type:f,async:!0,cache:this.options.timestamp,data:this.options.data,dataType:"json",error:function(){e.dtable.logger.error("Can't load definition resource from "+d)},success:c})}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_SOURCE,"json_url",{init:function(a,c){var d={url:"",method:"post"};this.data=null,this.isLoaded=!1,this.options=b.extend({},d,a),this.dtable=c},loading:function(a){function c(b){"count"in b&&"rows"in b||f.dtable.logger.error("Invalid source response"),f.data=b,f.isLoaded=!0,a()}function d(){f.dtable.logger.error("Can't load source resource from "+e)}var e=this.options.url,f=this;"get"==this.options.method?b.get(e,f.dtable.search.getParams(),c,"json").error(d):b.post(e,f.dtable.search.getParams(),c,"json").error(d)},getRows:function(){return this.data.rows},getCount:function(){return this.data.count}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_TEMPLATE,"nunjucks",{init:function(a,c){this.isLoaded=!1;var d={view_dir:"/views",table_template:"table.html",rows_template:"rows.html",pagination_template:"pagination.html"};this.dtable=c,this.options=$.extend({},d,a),this.template={table:!1,rows:!1,pagination:!1},this.env=new b.Environment(new b.WebLoader(this.options.view_dir))},loading:function(a){function b(a){c.template.table&&c.template.rows&&c.template.pagination&&(c.isLoaded=!0,a())}var c=this;this.env.getTemplate(this.options.table_template,function(d,e){d?c.dtable.logger.error(d):(c.dtable.logger.info("nunjucks.template.loading: "+c.options.table_template+" is loaded"),c.template.table=e,b(a))}),this.env.getTemplate(this.options.rows_template,function(d,e){d?c.dtable.logger.error(d):(c.dtable.logger.info("nunjucks.template.loading: "+c.options.rows_template+" is loaded"),c.template.rows=e,b(a))}),this.env.getTemplate(this.options.pagination_template,function(d,e){d?c.dtable.logger.error(d):(c.dtable.logger.info("nunjucks.template.loading: "+c.options.pagination_template+" is loaded"),c.template.pagination=e,b(a))})},getTableHtml:function(a){return this.template.table.render(a)},getRowsHtml:function(a){return this.template.rows.render(a)},getPaginationHtml:function(a){return this.template.pagination.render(a)}})}(DTableModule,nunjucks);
//# sourceMappingURL=dtable.jquery.min.map